#---------------------------------------------------------------------
# プログラム設定
#---------------------------------------------------------------------

AR = @lib
CC = @cl
LD = @link

RM = @del
RMDIR = rd /S /Q
MD = md

#---------------------------------------------------------------------
# 実行ファイル拡張子
#---------------------------------------------------------------------

EXE = .exe

#---------------------------------------------------------------------
# オブジェクトファイル用ディレクトリ
#---------------------------------------------------------------------

OBJ = obj

#---------------------------------------------------------------------
# ターゲットファイル名
#---------------------------------------------------------------------

TARGET = romcnv_cps2$(EXE)

#---------------------------------------------------------------------
# コンパイラ定義
#---------------------------------------------------------------------

CDEFS = \
	-DWINVER=0x0400 \
	-D_WIN32_WINNT=0x0500 \
	-DWIN32 \
	-D_WINDOWS \
	-DINLINE='static __inline' \
	-Dinline=__inline \
	-D__inline__=__inline \
	/Isrc /Isrc/cps2 /Isrc/zlib

CFLAGS = /nologo /W2 /GB /Ox /GA /GX /MT

#---------------------------------------------------------------------
# リンカフラグ
#---------------------------------------------------------------------

LDFLAGS = /nologo /machine:x86 /subsystem:console /release /incremental:no

#---------------------------------------------------------------------
# オブジェクトファイル/ディレクトリ設定
#---------------------------------------------------------------------

OBJDIRS = \
	$(OBJ) \
	$(OBJ)/cps2 \
	$(OBJ)/zlib \

OBJS = \
	$(OBJ)/cps2/romcnv.o \
	$(OBJ)/unzip.o \
	$(OBJ)/zfile.o

#---------------------------------------------------------------------
# ライブラリ設定
#---------------------------------------------------------------------

LIBS = \
	comdlg32.lib \
	shell32.lib \
	src/zip32j.lib \

#---------------------------------------------------------------------
# make
#---------------------------------------------------------------------

all: maketree $(TARGET)

include src/zlib/zlib.mak

$(TARGET): $(OBJS) $(OSOBJS)
	@echo Linking $@...
	$(LD) $(LDFLAGS) $(OBJS) $(OSOBJS) $(LIBS) /out:$@
	$(COMPRESS)

#---------------------------------------------------------------------
# コンパイルのルール設定
#---------------------------------------------------------------------

$(OBJ)/%.o: src/%.c
	@echo Compiling $<...
	$(CC) $(CDEFS) $(INCLUDES) $(DEBUGDEF) $(CFLAGS) /c $< /Fo$@

mkdir:
	@echo make mkdir is no longer necessary, just type make

$(sort $(OBJDIRS)):
	$(MD) $(subst /,\,$@)

maketree2:
	@echo Making object tree...

clean:
	$(RM) /Q $(OBJ)

maketree: maketree2 $(sort $(OBJDIRS))
